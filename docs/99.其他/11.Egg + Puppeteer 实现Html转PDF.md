---
title: Egg + Puppeteer å®ç°Htmlè½¬PDF
sidebar: auto
date: 2020-12-18 00:00:00
tags: 
  - æ˜é‡‘åˆ†äº«
  - æ‰“å°
categories: 
  - å‰ç«¯
permalink: /pages/dc00f73d9d1d9/
---
<p align="center">
  <img width="500" src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2d32c1b0135a4c1583fd02e45f0496b1~tplv-k3u1fbpfcp-watermark.image"/>
</p>

> è¦ä¸€ç›´å‘ä¸Šï¼Œè¦ä¿æŒæ»¡è…”çš„çƒ­è¡€

<!-- more -->
 ## èƒŒæ™¯
 
 é¡¹ç›®ç»„æœ‰ä¸ªç±»ä¼¼å¯Œæ–‡æœ¬ç¼–è¾‘å™¨åŠŸèƒ½ï¼Œåœ¨IEæµè§ˆå™¨ä¸‹éœ€è¦æ”¯æŒæ‰“å°ã€‚ä¸ºè§£å†³æ‰“å°å…¼å®¹æ€§é—®é¢˜ï¼Œéœ€è¦ä¸€å¥—æ ¹æ®Htmlè¾“å‡ºPDFçš„æœåŠ¡ã€‚
 
 so, æƒ³ç›´æ¥çœ‹ç»“æœçš„ï¼š [Htmlè½¬PDF åœ¨çº¿é¢„è§ˆ](http://118.25.49.69)  ğŸ˜ğŸ˜ğŸ˜
 
 ![](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/363c0d41e7964058a1cb5cda7d97b24b~tplv-k3u1fbpfcp-watermark.image)
 ## è°ƒç ”
 
 htmlè½¬pdfæ–¹æ¡ˆæœ‰å¾ˆå¤šï¼Œæ€ä¹ˆé€‰æ‹©ä¹Ÿçœ‹å„ä½çš„å…·ä½“æƒ…å†µ
 
 ### 1ã€chromeæµè§ˆå™¨è‡ªå¸¦
 ![](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a79c4d31f122416ab0e6046be3da88a8~tplv-k3u1fbpfcp-watermark.image)
 #### ç¼ºç‚¹ï¼š
 - éœ€è¦ç”¨æˆ·è‡ªå·±ç‚¹å‡»
 - ç”¨æˆ·éœ€è¦ä½¿ç”¨chromeç­‰æ”¯æŒçš„æµè§ˆå™¨
 - æ‰“å°é»˜è®¤æ˜¯å…¨å±€æ‰“å°
 ![](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/de59bb0fb31c48608b2d32f0f6aea9f6~tplv-k3u1fbpfcp-watermark.image)
 
 **å¹¿å‘Š**ï¼šå±€éƒ¨æ‰“å°å¯ä»¥å‚è€ƒæˆ‘çš„æ’ä»¶ğŸ˜ğŸ˜ğŸ˜: [vue-iframe-print](https://github.com/alexwjj/vue-iframe-print)
 
 `npm install vue-iframe-print` åœ¨éœ€è¦æ‰“å°çš„DOMä¸ŠåŠ ä¸Š`v-print`å³å¯å®ç°å±€éƒ¨æ‰“å°
 
 ### 2ã€html2canvas + jsPdf
 å®ç°å¯å‚è€ƒï¼š[Javascript å°†htmlè½¬æˆpdf,ä¸‹è½½,æ”¯æŒå¤šé¡µå“¦ï¼ˆhtml2canvas å’Œ jsPDFï¼‰](https://segmentfault.com/a/1190000009211079)
 #### ç¼ºç‚¹ï¼š
 - html2canvasæ’ä»¶åœ¨IEçš„å…¼å®¹æ€§é—®é¢˜
 - æ¸…æ™°åº¦é—®é¢˜
 - åˆ†é¡µé—®é¢˜
 - æ–‡å­—å›¾ç‰‡æˆªæ–­é—®é¢˜
 
 ### 3ã€nodeæœåŠ¡ç«¯è½¬æ¢
 - [wkthtmltopdf](https://wkhtmltopdf.org/) å‘è¾ƒå¤š~
 - [phantomjs](http://amirraminfar.com/phantomjs-node/#/)  åŸºäºwebkitçš„æ— å¤´æµè§ˆå™¨,ç¤¾åŒºä½¿ç”¨çš„ä¸å¤šï¼Œå¾ˆä¹…æ²¡æ›´æ–°äº†ï¼Œå¯ä»¥æ·±åº¦äº†è§£ä¸‹
 - [Puppeteer](https://zhaoqize.github.io/puppeteer-api-zh_CN/) + Headless Chrome  ç¤¾åŒºé‡Œä½¿ç”¨è¯¥æ–¹æ¡ˆçš„ä¹Ÿæ¯”è¾ƒå¤š
 
 ![](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/96cd59cc46834b22a7b3c3dd2ba864c7~tplv-k3u1fbpfcp-watermark.image)
 ## é€‰ç”¨Egg + Puppeteer ğŸ˜‰ğŸ˜‰ğŸ˜‰
 
 
å¦‚æœä½ æƒ³è‡ªå·±é‡å¤´å¼€å§‹æ­å»ºï¼Œå¯ä»¥å‚è€ƒï¼š[puppeteer ç”Ÿæˆpdfï¼Œç»å¯¹è§£å†³ä½ çš„éœ€æ±‚](https://blog.csdn.net/zhai_865327/article/details/104792646)

## éƒ¨ç½²ï¼ˆæ•²é»‘æ¿ï¼‰â—â—â—

å½“ä½ å·²ç»å®Œæˆäº†åŸºæœ¬åŠŸèƒ½ä»¥åï¼Œé«˜é«˜å…´å…´çš„ä»¥ä¸ºå°±å‰©ä¸‹æœ€åä¸€æ­¥äº†ï¼Œé‚£ä¹ˆå‘æ¥äº†~


### 1ã€åœ¨ Docker ä¸­ä½¿ç”¨ Puppeteer
 
 å®˜æ–¹æ–‡æ¡£æŒ‡å‡ºâ€œåœ¨ Docker ä¸­ä½¿ç”¨ headless Chrome å¹¶ä½¿å…¶è¿è¡Œèµ·æ¥å¯èƒ½ä¼šéå¸¸æ£˜æ‰‹â€ã€‚å®˜æ–¹æ–‡æ¡£æœ‰[ç–‘éš¾è§£ç­”éƒ¨åˆ†](https://github.com/puppeteer/puppeteer/blob/main/docs/troubleshooting.md#running-puppeteer-in-docker)ï¼Œä½ å¯ä»¥æ‰¾åˆ°æœ‰å…³ç”¨ Docker å®‰è£… puppeteer çš„æ‰€æœ‰å¿…è¦ä¿¡æ¯ã€‚
 
 å¦‚æœä½ åœ¨ Alpine é•œåƒä¸Šå®‰è£… Puppeteerï¼Œè¯·ç¡®ä¿åœ¨çœ‹åˆ°é¡µé¢çš„è¿™ä¸€éƒ¨åˆ†æ—¶å†å‘ä¸‹æ»šåŠ¨ä¸€ç‚¹ã€‚å¦åˆ™ä½ å¯èƒ½ä¼šå¿½ç•¥ä¸€ä¸ªäº‹å®ï¼šä½ æ— æ³•è¿è¡Œæœ€æ–°çš„ Puppeteer ç‰ˆæœ¬ï¼Œå¹¶ä¸”ä½ è¿˜éœ€è¦ç”¨ä¸€ä¸ªæ ‡è®°ç¦ç”¨ shm 
 
 ```
 const browser = await puppeteer.launch({
  headless: true,
  args: ['--disable-dev-shm-usage']
});
```
å¦åˆ™ï¼ŒPuppeteer å­è¿›ç¨‹å¯èƒ½ä¼šåœ¨æ­£å¸¸å¯åŠ¨ä¹‹å‰è€—å°½å†…å­˜ã€‚
### 2ã€åœ¨centOSä¸­éƒ¨ç½²

### ç¬¬ä¸€æ­¥ï¼šå®‰è£…chrome
å› ä¸ºæ˜¯ç›´æ¥ä½¿ç”¨çš„PuppeteeråŒ…ï¼Œéœ€è¦ä¾èµ–äºchromeå†…æ ¸ï¼Œæ‰€ä»¥ä½ åœ¨å¯åŠ¨é¡¹ç›®`npm install` çš„æ—¶å€™ä¼šä¸€ç›´å¡åœ¨`node install.js`è¿™é‡Œï¼Œå› ä¸ºchinaç½‘ç»œé—®é¢˜å’Œchromeå¤ªå¤§ï¼Œä½ å¾ˆéš¾åœ¨æœåŠ¡å™¨ä¸Šç›´æ¥éƒ¨ç½²æˆåŠŸã€‚

puppeteeræ”¯æŒæœ¬åœ°chromeå®‰è£…é“¾æ¥ï¼Œæ‰€ä»¥å¯ä»¥æ‰‹åŠ¨æŒ‡å®š

è·³è¿‡chromeå®‰è£…ï¼š`npm install puppeteer --ignore-scripts`

chromeå®‰è£…å…·ä½“å¯å‚è€ƒï¼š[é˜¿é‡Œäº‘æœåŠ¡å™¨ï¼ˆcentos7ï¼‰çš„ä½¿ç”¨ï¼ˆ7ï¼‰ä¸€Puppeteerå¯¼å‡ºPDFçš„éƒ¨ç½²å’Œä½¿ç”¨](https://blog.csdn.net/Zeng__Yi/article/details/105661354)

#### å‘å‡ºæ²¡ï¼Œwarning~
```
const browser = await puppeteer.launch({
      args: ['--disable-dev-shm-usage', '--no-sandbox'],
      headless:true,
      // linux chromeçš„é»˜è®¤å®‰è£…è·¯å¾„
      executablePath:'/opt/google/chrome/chrome'
  });
```
è¿™é‡Œå†™çš„puppeteerå¯åŠ¨è·¯å¾„`executablePath`æ˜¯linuxä¸‹chromeçš„å®‰è£…è·¯å¾„ï¼Œå¦‚æœæ¢äº†æœ¬åœ°ï¼Œä¸åŒçš„ç³»ç»Ÿå¯¹åº”çš„è·¯å¾„å¯èƒ½éƒ½ä¸ä¸€æ ·~  åƒè¾›ä¸‡è‹¦æ‰¾äº†ä¸€ä¸ªåŒ…ï¼Œå¾ˆå¥½ç”¨~ `npm install carlo`

å…³äº`carlo`ï¼Œå¯ä»¥å»äº†è§£ä¸‹ï¼š[ã€Carloã€ ä¸€ä¸ªæ–°çš„ Electron ?](https://zhuanlan.zhihu.com/p/48319397)
```
'use strict';
const puppeteer = require('puppeteer');

const findChrome = require('../../node_modules/carlo/lib/find_chrome');

let browser = null;

module.exports = async () => {
  if (!browser) {
    const findChromePath = await findChrome({});
    // browser = await puppeteer.launch();
    browser = await puppeteer.launch({
      headless: true,
      // chromeçš„é»˜è®¤å®‰è£…è·¯å¾„
      executablePath: findChromePath.executablePath,
      args: [
        '--disable-gpu',
        '--disable-dev-shm-usage',
        '--disable-setuid-sandbox',
        '--no-first-run',
        '--no-sandbox',
        '--no-zygote',
        '--single-process',
      ],
    });
  }
  return browser;
};

```

### ç¬¬äºŒæ­¥ï¼šéƒ¨ç½²è„šæœ¬

è™½ç„¶eggæœ‰è‡ªå·±çš„è¿›ç¨‹ç®¡ç†ï¼Œä½†æ˜¯è¿™é‡Œè¿˜æ˜¯æ¨èä½¿ç”¨pm2ï¼Œåœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹

æ–°å»º deploy.sh
```
# éƒ¨ç½²è„šæœ¬
type node
npm install puppeteer --ignore-scripts
npm install
pm2 kill
# ç¡çœ ï¼Œé¿å…å‡ºç°é”™è¯¯ï¼šSpawning PM2 daemon with pm2_home
sleep 2
pm2 start pm2.config.json
```
æ–°å»º pm2.config.json
```
{
  "apps": [
    {
      "name": "html-to-pdf",
      "script": "npm",
      "args": "run start",
      "log_date_format": "YYYY-MM-DD HH:mm:ss",
      "exec_mode": "fork",
      "max_memory_restart": "500M"
    }
  ]
}
```
### ä¸€åˆ‡å°±ç»ªï¼Œå¯åŠ¨ï¼ï¼ï¼
åœ¨æœåŠ¡å™¨çš„é¡¹ç›®ä¸­æ‰§è¡Œ`sh deploy.sh`, pm2æ˜¾ç¤ºå¯åŠ¨æˆåŠŸå³å¯

è¿™ä¸ªæ—¶å€™æœåŠ¡æ˜¯æ²¡é—®é¢˜äº†ï¼Œä½†æ˜¯å…¶ä»–é—®é¢˜å°±æ¥äº†ï¼Œå› ä¸ºæœåŠ¡å™¨ä¸Šæ˜¯æ²¡æœ‰ä¸­æ–‡å­—ä½“åº“çš„~æ‰€ä»¥ç”Ÿæˆçš„pdfï¼Œä¸­æ–‡å­—ä½“å…¨æ˜¯ä¹±ç 

![](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1eecfaf7894f4666b1399d3320832291~tplv-k3u1fbpfcp-watermark.image)

### ç¬¬ä¸‰æ­¥ï¼šå®‰è£…å­—ä½“
ä¸€ã€å®‰è£…fontconfig
`yum -y install fontconfig`
è¿™ä¸ªå‘½ä»¤æ‰§è¡Œå®Œæˆä¹‹åï¼Œå°±å¯ä»¥åœ¨`/usr/share`æ–‡ä»¶å¤¹é‡Œé¢çœ‹åˆ°fontså’Œfontconfig
äºŒã€æ·»åŠ ä¸­æ–‡å­—ä½“åº“
- ä»windowçš„`C:\Windows\Fonts`é‡Œé¢å­—ä½“æ‹·è´ä¸€ä»½ï¼Œæˆ–è€…åªé€‰æ‹©ä½ éœ€è¦çš„
- åœ¨CentOSçš„`/usr/share/fonts`æ–°å»ºä¸€ä¸ªå«chineseçš„æ–‡ä»¶å¤¹
- ç„¶åæŠŠåˆšåˆšæ‹·è´å­—ä½“æ”¾åˆ°CentOSçš„`/usr/share/fonts/chinese`é‡Œé¢
- ä¿®æ”¹chineseç›®å½•çš„æƒé™ã€‚`chmod -R 775 /usr/share/fonts/chinese`
- æ¥ä¸‹æ¥éœ€è¦å®‰è£…`ttmkfdir`æ¥æœç´¢ç›®å½•ä¸­æ‰€æœ‰çš„å­—ä½“ä¿¡æ¯ï¼Œå¹¶æ±‡æ€»ç”Ÿæˆfonts.scaleæ–‡ä»¶ï¼Œè¾“å…¥å‘½ä»¤`yum -y install ttmkfdir`
- æ‰§è¡Œttmkfdirå‘½ä»¤ï¼Œ `ttmkfdir -e /usr/share/X11/fonts/encodings/encodings.dir`
- æ‰“å¼€å­—ä½“é…ç½®æ–‡ä»¶ï¼Œ`vi /etc/fonts/fonts.conf`ï¼Œæ·»åŠ ä¸‹é¢è¿™ä¸€æ®µ
```
<!-- Font directory list -->
<dir>/usr/share/fonts</dir>
<dir>/usr/share/X11/fonts/Type1</dir>
<dir>/usr/share/X11/fonts/TTF</dir>
<dir>/usr/local/share/fonts</dir>
<dir>/usr/local/share/fonts/chinese</dir>
<dir>~/.fonts</dir>
```
- åˆ·æ–°å†…å­˜ä¸­çš„å­—ä½“ç¼“å­˜ï¼Œfc-cache
- çœ‹ä¸€ä¸‹ç°åœ¨æœºå™¨ä¸Šå·²ç»æœ‰äº†åˆšæ‰æ·»åŠ çš„å­—ä½“ã€‚fc-list :lang=zh


## å¤§åŠŸå‘Šæˆ
è¿™ä¸ªæ—¶å€™åŸºæœ¬å°±æ²¡é—®é¢˜äº†, åç»­é‡åˆ°çš„é—®é¢˜å†æ›´æ–°ã€‚

 ![](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/967055123abf44c794f39a474474e041~tplv-k3u1fbpfcp-watermark.image)
 
 ## æœ€åï¼šIEåŠ è½½PDF
 éœ€è¦å®‰è£…ä¸‹adobe reader
 ![](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c649e383990e4f3787516bbba6a8f44f~tplv-k3u1fbpfcp-watermark.image)

 ## å‚è€ƒ
 - [Javascript å°†htmlè½¬æˆpdf,ä¸‹è½½,æ”¯æŒå¤šé¡µå“¦ï¼ˆhtml2canvas å’Œ jsPDFï¼‰](https://segmentfault.com/a/1190000009211079)
 - [htmlè½¬PDFæ–‡ä»¶ï¼Œå®Œç¾è§£å†³æ–¹æ¡ˆâ€”â€”jsPDF,htmltocanvas,pdfmake,wkhtmltopdf,TuesPechkin,snappy](https://juejin.cn/post/6844903612993241101)
 - [åˆ©ç”¨puppeteerå’Œegg.jså®ç°html2pdfã€html2pngã€‚](https://zhuanlan.zhihu.com/p/158204817)
 - [page.pdf([options])](https://zhaoqize.github.io/puppeteer-api-zh_CN/#?product=Puppeteer&version=v5.5.0&show=api-pagepdfoptions)
 
 ![](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dec3b75bd7a24e4bbbc89040d69ec311~tplv-k3u1fbpfcp-watermark.image)
 
 
 
 
 
 
 

